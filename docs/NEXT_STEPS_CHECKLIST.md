# Чек-лист: ближайшие шаги (стабильность и поле)

## Включаемые фичи (только включить и протестить)

Уже есть в коде, нужно только выставить переменные окружения или флаги.

### Фрейм-паддинг (анти-паттерн по длинам пакетов)

Рандомный паддинг к каждому фрейму — DPI сложнее анализировать по размеру.

- **Клиент:** в конфиге или env задать `ASTRA_FRAME_MIN_PAD=16` и `ASTRA_FRAME_MAX_PAD=64`.
- **Entry:** те же переменные в конфиге/env Entry: `ASTRA_FRAME_MIN_PAD=16`, `ASTRA_FRAME_MAX_PAD=64`.
- Значения должны совпадать по смыслу (оба с паддингом). После этого перезапустить клиент и Entry и гонять трафик — в логах ничего особенного не изменится, но фреймы станут с паддингом.

### Keepalive (включён по умолчанию, можно отключить для теста)

- По умолчанию клиент раз в 3 секунды шлёт keepalive. Интервал задаётся **ASTRA_KEEPALIVE_SEC** (по умолчанию 3).
- Чтобы **отключить** keepalive и посмотреть, как быстро «умрёт» соединение (NAT/фаервол): задать **ASTRA_KEEPALIVE_SEC=0**. Перезапустить клиент. Удобно для теста «долгая сессия без keepalive».

### Лог статистики TUN (раз в N секунд)

- По умолчанию раз в 5 секунд в лог пишется `tun stats: tx=... rx=...`.
- **ASTRA_LOG_TUN_STATS_SEC=0** — отключить эти сообщения (меньше шума в логах).
- **ASTRA_LOG_TUN_STATS_SEC=60** — раз в минуту (удобно для долгих сессий).

### Транспорт QUIC

- Транспорт **quic** добавлен: поверх UDP, встроенный TLS 1.3, один поток на соединение.
- **Клиент:** по умолчанию в списке транспортов теперь первым идёт `quic` (`ASTRA_TRANSPORTS=quic,tls,rudp,tcp`). Подключение к Entry по UDP (адрес и порт те же, что для TCP, но протокол другой).
- **Entry:** чтобы слушать QUIC, задать **ENTRY_TRANSPORT=quic** и **ENTRY_ADDR=** например **:8444** (порт лучше отдельный от TCP/TLS, т.к. QUIC слушает UDP). Сертификат общий с TLS: `ENTRY_TLS_CERT` / `ENTRY_TLS_KEY`.
- **Relay/Exit:** если Entry проксирует на следующий узел по QUIC, указать **ENTRY_FORWARD_TRANSPORT=quic** и **ENTRY_NEXT_ADDR=** адрес следующего узла (он должен слушать QUIC на этом адресе).

---

## 1. Долгие сессии (24–72 ч)

**Да, нужно держать туннель включённым сутки и больше** — чтобы увидеть утечки памяти, обрывы, переподключения.

### Что сделать

- Запустить **Entry + Exit** (и при необходимости Relay) на сервере.
- На Windows запустить **astra-tun-client** (или GUI) от имени администратора, подключиться.
- Оставить на **24 часа** (минимум). Лучше 48–72 ч.
- Периодически пользоваться интернетом через туннель (браузер, мессенджеры), чтобы был не только idle.

### Что смотреть

- Не падает ли процесс клиента или сервера.
- Не растёт ли потребление памяти (Диспетчер задач → детали, смотреть процесс astra-tun-client / entry / exit).
- Остаётся ли пинг и доступ в интернет или туннель «засыпает» и перестаёт отвечать.
- Появляются ли в логах ошибки (reconnect, handshake failed, timeout).

### Минимум для «зачёта»

- 24 ч без падения и без сильного роста памяти (например, не более +50–100 МБ за сутки).

---

## 2. Прогон DPI lab

Lab — это **прокси между клиентом и Entry**, который может рвать соединения, добавлять задержки, имитировать DPI.

### Что есть

- `cmd/astra-lab/main.go` — два режима:
  - **proxy** — слушает `LAB_LISTEN_ADDR`, прокидывает трафик на `LAB_TARGET_ADDR` (адрес Entry), может дропать часть соединений (`LAB_DROP_PCT`), задерживать (`LAB_DELAY_MS`), обрывать после N байт (`LAB_RESET_AFTER_BYTES`).
  - **load** — нагружает целевой адрес множеством соединений (для стресс-теста).

### Как прогнать

1. **Собрать lab:**  
   `go build -o astra-lab.exe ./cmd/astra-lab`

2. **Запустить Entry** на каком-то порту, например `127.0.0.1:8443`.

3. **Запустить lab как прокси** между клиентом и Entry:
   - Lab слушает, например, `127.0.0.1:18080` и пересылает на `127.0.0.1:8443`.
   - В конфиге клиента указать подключение к `127.0.0.1:18080` (вместо прямого Entry).

4. **Варианты прогона:**
   - Без дропов: просто проверка, что через lab всё работает.
   - С дропами: `LAB_DROP_PCT=5` или `10` — часть соединений обрывается; смотреть, как клиент переподключается.
   - С обрывом после N байт: `LAB_RESET_AFTER_BYTES=10000` — имитация «резания» по размеру; смотреть стабильность.

5. **Конфиг** (если используете): `configs/astra-lab.json` — там же `LAB_LISTEN_ADDR`, `LAB_TARGET_ADDR`, `LAB_DROP_PCT`, `LAB_DELAY_MS`, `LAB_RESET_AFTER_BYTES`.

Пример запуска lab (proxy):
```text
set LAB_TARGET_ADDR=127.0.0.1:8443
astra-lab.exe
```
Клиент подключается к `127.0.0.1:18080`.

---

## 3. Метрики и логи без PII

Цель — считать отказы и ошибки, **не** логировать IP пользователей, домены, содержимое трафика.

### Что добавить (идеи)

- **Entry/Exit:** счётчики в памяти или в лог в структурированном виде:
  - `auth_ok`, `auth_deny`, `handshake_error`, `conn_closed`, `bytes_in`, `bytes_out`.
- **Формат:** одна строка на событие, например JSON:  
  `{"ts":"...","event":"auth_deny","reason":"TOKEN_INVALID"}`  
  без IP/токенов/ClientID в открытом виде (можно хэш или «client_id_hash»).
- **Клиент:** при разрыве или ошибке handshake писать в лог событие (без привязки к конкретным сайтам/запросам): например `disconnect`, `handshake_failed`, `transport_failed`.

### Что сделать сейчас

- Определить список событий (auth_ok, auth_deny, handshake_failed, reconnect, …).
- В местах, где уже есть логирование, убедиться, что не пишутся IP, домены, токены.
- Опционально: вынести счётчики в Prometheus/метрики, если планируете мониторинг.

---

## 4. CI-тесты

Цель — при каждом коммите/пуше прогонять базовые тесты.

### Что тестировать

- **Unit:** handshake (подпись, проверка, коды ошибок), framing, при необходимости auth/token.
- **Интеграция (если есть):** один сценарий «клиент подключается к Entry, отправляет данные, Exit отдаёт в TUN» в одной сети или в CI (например, с локальным Entry/Exit).

### Что сделать

1. Написать/дописать тесты в `*_test.go` рядом с пакетами:
   - `internal/protocol/handshake_test.go`
   - по необходимости `internal/transport/*_test.go`, `internal/auth/*_test.go`.
2. Запуск: `go test ./...` из корня репозитория.
3. CI: в GitHub Actions / GitLab CI / другом — один job: `go test ./...`. При падении теста — красный билд.

Минимум для старта: `go test ./internal/protocol/ ./internal/auth/` и при необходимости один E2E-скрипт (запуск entry+exit+client в фоне, проверка, что пинг до 10.10.0.1 проходит).

---

## Кратко

| Шаг | Что делать |
|-----|------------|
| **Долгие сессии** | Держать туннель 24–72 ч, смотреть память и обрывы. |
| **DPI lab** | Собрать `astra-lab`, вставить прокси между клиентом и Entry, гонять с дропами/обрывами. |
| **Метрики/логи** | Счётчики auth/handshake/errors без PII; проверить, что в логах нет IP/токенов. |
| **CI** | `go test ./...`, при необходимости один E2E; настроить пайплайн на `go test`. |
